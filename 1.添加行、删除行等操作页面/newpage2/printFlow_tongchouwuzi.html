<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>printFlow</title>
    <script type="text/javascript" src="../newpage/js/jquery-1.11.1.min.js"></script>
    <script src="../../../xlSystem/XL/js/main.js"></script>
    <script src="../../../Scripts/layer/layer.js"></script>
    <script src="../newpage/js/vue.js"></script>
    <link rel="stylesheet" type="text/css" href="printFlow_tongchouwuzi.css?v=2">

</head>
<body>
<div id="app" v-cloak class="clearFloat">
    <!--头部-->
    <div class="imgBox">
        <img src="pic/printFlow.png">
    </div>
    <div class="titleText">{{contentData1.title}}</div>
    <div class="floatLeft">
        <!--新娘家（酒店）物资准备-->
        <div class="bride_home">
            <div class="base_news_inner">
                <span>新娘家（酒店）物资准备</span>
            </div>
            <table class="table_01" cellpadding="0" cellspacing="0">
                <thead style="text-align: center">
                <tr @contextmenu="rightClickEvent2($event)">
                    <td>物品名称</td>
                    <td>物品用途</td>
                </tr>
                </thead>
                <tbody @contextmenu="rightClickEvent($event)">

                <template v-for="(items1,index) in contentData1_01">

                    <tr v-if="items1.Personnel!='备注'" :data-index="items1.Sort" :id="items1.Id" :key="items1.Id">
                        <td>
                            <div contenteditable="true" class="textArea" @blur="changeText($event)"
                                 v-text="items1.Personnel" style="width: 130px">
                            </div>
                        </td>
                        <td>
                            <div contenteditable="true" class="textArea" @blur="changeText($event)"
                                 v-text="items1.Article"
                                 style="width: 160px">
                            </div>
                        </td>
                    </tr>
                    <tr v-if="items1.Personnel=='备注'" :data-index="items1.Sort" :id="items1.Id" :key="items1.Id">
                        <td colspan="2">
                            <span style="color: #E8738C;">备注：</span>
                            <div contenteditable="true" class="textArea2" @blur="changeText2($event)"
                                 style="width: 320px"
                                 v-text="items1.Article">
                            </div>
                        </td>
                    </tr>

                </template>
                </tbody>
                <tfoot class="bigLengthFoot">
                <tr style="height: 30px;"></tr>
                </tfoot>
            </table>

        </div>
        <!--/新娘家（酒店）物资准备-->

        <!--宴会物资准备-->
        <div class="banquet_supplies">
            <div class="personnel_time_inner">
                <span>宴会物资准备</span>
            </div>
            <table class="table_03" cellpadding="0" cellspacing="0">
                <thead style="text-align: center">
                <tr @contextmenu="rightClickEvent2($event)">
                    <td>物品名称</td>
                    <td>物品用途</td>
                </tr>
                </thead>
                <tbody @contextmenu="rightClickEvent($event)">
                <template v-for="(items3,index) in contentData1_03">
                    <tr v-if="items3.Personnel!='备注'" :data-index=" items3.Sort" :id="items3.Id" :key="items3.Id">
                        <td>
                            <div contenteditable="true" class="textArea" @blur="changeText($event)" style="width: 130px"
                                 v-text="items3.Personnel">
                            </div>
                        </td>
                        <td>
                            <div contenteditable="true" class="textArea" @blur="changeText($event)" style="width: 160px"
                                 v-text="items3.Article">
                            </div>
                        </td>
                    </tr>
                    <tr v-if="items3.Personnel=='备注'" :data-index="items3.Sort" :id="items3.Id">
                        <td colspan="2">
                            <span style="color: #E8738C;">备注：</span>
                            <div contenteditable="true" class="textArea2" @blur="changeText2($event)"
                                 style="width: 320px"
                                 v-text="items3.Article">
                            </div>
                        </td>
                    </tr>
                </template>
                </tbody>
                <tfoot>
                <tr style="height: 80px;"></tr>
                </tfoot>
            </table>
        </div>
        <!--/宴会物资准备-->
    </div>

    <div class="floatRight">
        <!--新郎家（新房）物资准备-->
        <div class="groom_home">
            <div class="personnel_time_inner">
                <span>新郎（新房）家物资准备</span>
            </div>
            <table class="table_02" cellpadding="0" cellspacing="0">
                <thead style="text-align: center">
                <tr @contextmenu="rightClickEvent2($event)">
                    <td>物品名称</td>
                    <td>物品用途</td>
                </tr>
                </thead>
                <tbody @contextmenu="rightClickEvent($event)">
                <template v-for="(items2,index) in contentData1_02">
                    <tr v-if="items2.Personnel!='备注'" :data-index="items2.Sort" :id="items2.Id" :key="items2.Id">
                        <td>
                            <div contenteditable="true" class="textArea" @blur="changeText($event)" style="width: 130px"
                                 v-text="items2.Personnel">
                            </div>
                        </td>
                        <td>
                            <div contenteditable="true" class="textArea" @blur="changeText($event)" style="width: 160px"
                                 v-text="items2.Article">
                            </div>
                        </td>
                    </tr>
                    <tr v-if="items2.Personnel=='备注'" :data-index="items2.Sort" :id="items2.Id" :key="items2.Id">
                        <td colspan="2">
                            <span style="color: #E8738C;">备注：</span>
                            <div contenteditable="true" class="textArea2" @blur="changeText2($event)"
                                 style="width: 320px"
                                 v-text="items2.Article">
                            </div>
                        </td>
                    </tr>
                </template>
                </tbody>
                <tfoot class="bigLengthFoot">
                <tr style="height: 30px;"></tr>
                </tfoot>
            </table>
        </div>
        <!--/新郎家（新房）物资准备-->

        <!--喜来婚礼提供物资-->
        <div class="xiLai_supplies">
            <div class="personnel_time_inner">
                <span>喜来婚礼提供物资</span>
            </div>
            <table class="table_04" cellpadding="0" cellspacing="0">
                <thead style="text-align: center">
                <tr @contextmenu="rightClickEvent2($event)">
                    <td>物品名称</td>
                    <td>物品用途</td>
                </tr>
                </thead>
                <tbody @contextmenu="rightClickEvent($event)">
                <template v-for="(items4,index) in contentData1_04">
                    <tr v-if="items4.Personnel!='备注'" :data-index="items4.Sort" :id="items4.Id" :key="items4.Id">
                        <td>
                            <div contenteditable="true" class="textArea" @blur="changeText($event)" style="width: 130px"
                                 v-text="items4.Personnel">
                            </div>
                        </td>
                        <td>
                            <div contenteditable="true" class="textArea" @blur="changeText($event)" style="width: 160px"
                                 v-text="items4.Article">
                            </div>
                        </td>
                    </tr>
                    <tr v-if="items4.Personnel=='备注'" :data-index="items4.Sort" :id="items4.Id" :key="items4.Id">
                        <td colspan="2">
                            <span style="color: #E8738C;">备注：</span>
                            <div contenteditable="true" class="textArea2" @blur="changeText2($event)"
                                 style="width: 320px"
                                 v-text="items4.Article">
                            </div>
                        </td>
                    </tr>

                </template>
                </tbody>
                <tfoot>
                <tr style="height: 80px;"></tr>
                </tfoot>
            </table>
        </div>
        <!--/喜来婚礼提供物资-->
    </div>

    <!--页脚-->
    <div class="footer">
        <img src="pic/printFlow_foot.png" alt="页脚">
    </div>
    <!--/页脚-->


    <!-- 右键点击菜单 -->
    <div id="menu">
        <div class="menu" @click="up_data">上方新添加一行</div>
        <div class="menu" @click="down_data">下方新添加一行</div>
        <div class="menu" @click="del_data">删除当前这一行</div>
    </div>


    <!-- 漂浮打印按钮 -->
    <div class="all_float" @click="test()">打印</div>

    <!--二维码-->
    <div class="miniIcon">
        <img src="pic/mini.png" height="48" width="48" @mouseEnter="show" @mouseleave="hide"/>
        <div class="codeImage" :class="{show:showCode}">
            <img src="http://192.168.1.192:5080/View/SupplierFile/getcodeimage.ashx?oid=3a023802-b35d-4925-b665-b01f588f3115&type=126"
                 id="qrCodeImage" height="160" width="150"/>

            <div>扫描小程序</div>
        </div>
    </div>


</div>
</body>

<script>
    (function () {
        var loading = {
            img: document.createElement("img"),
            imgSrc: ['pic/loading2.gif'],
            showImg: function () {
                this.initImg();
            },
            hideImg: function () {
                this.img.style.display = "none"
            },
            initImg: function () {
                this.img.src = this.imgSrc[0];
                this.img.className = "loadingImg";
                document.getElementsByTagName("body")[0].appendChild(this.img);
                this.img.style.position = "absolute";
                this.img.style.top = "50%";
                this.img.style.left = "50%";
                this.img.style.transform = "translate(-50%,-50%)";
                this.img.style.zIndex = "99999";
                this.img.style.display = "block"
            }
        };
        window.loading = loading;
    })();
    var orderid = GetQueryString("orderId");
    var api = getkevalue().apiurl;
    var data_index;//当前行索引
    var flowPath;//所属区块
    var thisId;//id
    var suoshuqu;//所属区代号
    //数据对象
    var myData = {
        contentData1: [],
        contentData1_01: [],
        contentData1_02: [],
        contentData1_03: [],
        contentData1_04: [],
        showCode: false
    };

    //事件对象
    var myMethods = {
        //鼠标右击事件
        rightClickEvent(event) {
            event.preventDefault();

            data_index = $(event.target).parent().parent().attr("data-index");
            thisId = $(event.target).parent().parent().attr("id");
            flowPath = $(event.target).parent().parent().parent().parent().prev().children("span").text();
            if (data_index == undefined) {
                data_index = $(event.target).parent().attr("data-index");
            }
            if (thisId == undefined) {
                thisId = $(event.target).parent().attr("id");
            }
            if (flowPath == "") {
                flowPath = $(event.target).parent().parent().parent().prev().children("span").text();
            }
            $("#menu").show();
            $("#menu").css({
                top: event.clientY + 'px',
                left: event.clientX + 'px',
            });

            if (flowPath == "新娘家（酒店）物资准备") {
                suoshuqu = 1;
            } else if (flowPath == "新郎（新房）家物资准备") {
                suoshuqu = 2;
            } else if (flowPath == "宴会物资准备") {
                suoshuqu = 3;
            } else if (flowPath == "喜来婚礼提供物资") {
                suoshuqu = 4;
            }
        },

        rightClickEvent2(event) {
            event.preventDefault();
            data_index = 0;
            flowPath = $(event.target).parent().parent().parent().prev().children("span").text();
            $("#menu").show();
            $("#menu").css({
                top: event.clientY + 'px',
                left: event.clientX + 'px',
            });
        },

        //调用浏览器打印
        test() {
            window.print();
        },
        //上方新添加一行
        up_data() {
            addRow();
            $("#menu").hide();
        },
        //下方新添加一行
        down_data() {
            data_index = parseInt(data_index) + 1;
            addRow();
            $("#menu").hide();
        },
        //删除当前这一行
        del_data() {
            delThisRow();
            $("#menu").hide();
        },
        show() {
            this.showCode = !this.showCode;
        },
        hide() {
            this.showCode = !this.showCode;
        },
        //修改文字1
        changeText(event) {
            var ID = $(event.target).parent().parent().attr("id");
            var index = $(event.target).parent().parent().attr("data-index");//当前行
            var personnel = $(event.target).parent().parent().children().eq(0).find(".textArea").text();//名称
            var article = $(event.target).parent().parent().children().eq(1).find(".textArea").text();//用途
            var flowPath = $(event.target).parent().parent().parent().parent().prev().children("span").text();//所属区块
            changeThisTdText(ID, index, personnel, article, flowPath);
        },
        //修改文字2
        changeText2(event) {
            var ID = $(event.target).parent().parent().attr("id");
            var index = $(event.target).parent().parent().attr("data-index");//当前行
            var personnel = "备注";//名称
            var article = $(event.target).text();//用途
            var flowPath = $(event.target).parent().parent().parent().parent().prev().children("span").text();//所属区块
            changeThisTdText(ID, index, personnel, article, flowPath);
        }
    };

    //添加一行
    function addRow() {

        var FlowPath = flowPath;//所属区块
        var Sort = parseInt(data_index);//当前位置
        // console.log(suoshuqu);
        var data = {
            FlowPath: FlowPath,
            Personnel: "",
            Article: "",
            Type: "2",
            Sort: Sort,
            show: true,
            OrderId: orderid
        };
        var url = api + '/xlapi/FlowScheme/Operation/FlowScheme/AddRow';
        $.ajax({
            type: 'post',
            url: url,
            data: {modelJson: data},
            success: res => {
                // console.log(res)
                if (res.status == 'OK') {
                    loadStartData();
                }
            }
        })
    }

    //删除一行
    function delThisRow() {

        var FlowPath = flowPath;//所属区块
        var Sort = parseInt(data_index);//当前位置
        var data = {
            FlowPath: FlowPath,
            Type: "2",
            Sort: Sort,
            Id: thisId,
            show: true,
            OrderId: orderid
        };
        var url = api + '/xlapi/FlowScheme/Operation/FlowScheme/DeleteRow?no=' + Math.random() * 10 + 10;
        $.ajax({
            type: 'post',
            url: url,
            data: {modelJson: data},
            success: res => {
                // console.log(res);
                if (res.status == 'OK') {
                    loadStartData();
                }
            }
        })
    }

    //修改文字
    function changeThisTdText(ID, index, personnel, article, flowPath) {
        var data = {
            FlowPath: flowPath,
            Personnel: personnel,
            Article: article,
            Type: 2,
            Sort: index,
            show: true,
            OrderId: orderid,
            Id: ID,
        };
        var url = api + '/xlapi/FlowScheme/Operation/FlowScheme/EditRow?no=' + Math.random() * 10 + 20;
        $.ajax({
            type: 'post',
            url: url,
            cache: false,
            async: false,
            data: {modelJson: data},
            success: res => {
                // console.log(res)
                if (res.status == 'OK') {
                    loadStartData();
                }
            }
        })
    }

    //加载初始数据
    function loadStartData() {

        var data = {
            orderid: orderid,
            type: 2    //写死
        };
        var url = api + '/xlapi/FlowScheme/Operation/FlowScheme/GetPreparMaterial?no=' + Math.random() * 10;
        $.ajax({
            type: 'post',
            url: url,
            data: data,
            dataType: 'JSON',
            complete: res => {
                loading.hideImg();
            },
            success: res => {
                // console.log(res.data);
                vm.$forceUpdate();
                vm.contentData1 = res;
                vm.contentData1_01 = res.data.modelList1;
                vm.contentData1_02 = res.data.modelList2;
                vm.contentData1_03 = res.data.modelList3;
                vm.contentData1_04 = res.data.modelList4;
            }
        })
    }

    window.onclick = function (e) {
        document.querySelector('#menu').style.display = 'none';
    }

    //Vue对象
    var vm = new Vue({
        el: "#app",
        data: myData,
        created() {
            loadStartData();//加载初始数据
        },
        methods: myMethods,

    })

</script>

</html>
